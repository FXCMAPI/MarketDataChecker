'use strict';
let APdasBatchRequestMessage = require('./APdasBatchRequestMessage.js');
let PdasMessageFieldFactory = require('./PdasMessageFieldFactory.js');
let PdasMessageSerializer = require('./PdasMessageSerializer.js');
let PdasMessageFieldTag = require('./PdasMessageFieldTag.js');
let PdasConstants = require('./PdasConstants.js');
let PdasTransportMessage = require('./PdasTransportMessage.js');
let TransportMessageType = require('./TransportMessageType.js');
let variantCast = require('@gehtsoft/LuaxStdlib-node').variantCast;
let PdasMessageType = require('./PdasMessageType.js');
class PdasPriceFeedBatchCommandMessage extends APdasBatchRequestMessage {
    build(priceSession, terminal, priceDescriptors, requestNumberGenerator, forceReset, transactTime) {
        let pdasMessageSerializer, factory, pdasMessage, requestId, pdasMessageList, result, terminalUrl, i;
        factory = new PdasMessageFieldFactory();
        pdasMessageSerializer = new PdasMessageSerializer();
        terminalUrl = terminal.getUrls()[0];
        requestId = priceSession.getSessionId() + "-" + (requestNumberGenerator.getNextRequestNumber()).toString();
        pdasMessage = APdasBatchRequestMessage.createMdtBatchMessage(0, factory, terminal, transactTime, requestId);
        if (forceReset) {
            pdasMessage.addChild(factory.createStringField(PdasMessageFieldTag.FXCM_FORCE_RESET, "Y"));
        }
        else {
            pdasMessage.addChild(factory.createStringField(PdasMessageFieldTag.FXCM_FORCE_RESET, "N"));
        }
        pdasMessageList = factory.createList(PdasMessageFieldTag.FXCM_EMB_MSG);
        for (i = 0; i <= priceDescriptors.length - 1; i += 1) {
            pdasMessageList.addChild(this.createGroup(factory, priceSession, requestNumberGenerator, priceDescriptors[i], terminal));
        }
        pdasMessage.addChild(pdasMessageList);
        pdasMessage.addChild(factory.createIntField(PdasMessageFieldTag.BATCH_RESPONSE, 0));
        pdasMessage.addChild(factory.createStringField(PdasConstants.SID, priceSession.getSessionId()));
        result = PdasTransportMessage.create(TransportMessageType.PriceFeedBatchCommand, this.createRequestUrl(terminalUrl), pdasMessageSerializer.serialize(pdasMessage));
        return result;
    }
    createGroup(factory, priceSession, requestNumberGenerator, commandDescriptor, priceTerminal) {
        let requestId, pdasMessageList, group, mainGroup, i, fxcmIncludeWeekends, instruments;
        requestId = priceSession.getSessionId() + "-" + (requestNumberGenerator.getNextRequestNumber()).toString();
        mainGroup = factory.createGroup();
        if (commandDescriptor.getFxcmIncludeWeekends()) {
            fxcmIncludeWeekends = "true";
        }
        else {
            fxcmIncludeWeekends = "false";
        }
        pdasMessageList = factory.createList(PdasMessageFieldTag.NO_RELATED_SYM);
        instruments = commandDescriptor.getInstrumentDescriptors();
        for (i = 0; i <= instruments.length - 1; i += 1) {
            group = factory.createGroup();
            group.addChild(factory.createStringField(PdasMessageFieldTag.SYMBOL, instruments[i].getSymbol()));
            group.addChild(factory.createIntField(PdasMessageFieldTag.FXCM_SYM_ID, variantCast.fromString(instruments[i].getOfferId()).asInt()));
            group.addChild(factory.createIntField(PdasMessageFieldTag.FXCM_SYM_PRECISION, 0));
            pdasMessageList.addChild(group);
        }
        mainGroup.addChild(pdasMessageList);
        mainGroup.addChild(factory.createStringField(PdasMessageFieldTag.MD_REQ_ID, requestId));
        mainGroup.addChild(factory.createStringField(PdasMessageFieldTag.SUBSCRIPTION_REQUEST_TYPE, commandDescriptor.getSubscriptionRequestType()));
        mainGroup.addChild(factory.createIntField(PdasMessageFieldTag.MARKET_DEPTH, commandDescriptor.getMarketDepth()));
        mainGroup.addChild(factory.createIntField(PdasMessageFieldTag.MD_UPDATE_TYPE, commandDescriptor.getMdUpdateType()));
        pdasMessageList = factory.createList(PdasMessageFieldTag.NO_MD_ENTRY_TYPES);
        mainGroup.addChild(pdasMessageList);
        mainGroup.addChild(factory.createStringField(PdasMessageFieldTag.TRADING_SESSION_ID, priceTerminal.getId()));
        mainGroup.addChild(factory.createStringField(PdasMessageFieldTag.MSG_TYPE, PdasMessageType.PRICE_FEED_MESSAGE));
        pdasMessageList = factory.createList(PdasMessageFieldTag.NO_TRADING_SESSIONS);
        group = factory.createGroup();
        group.addChild(factory.createStringField(PdasMessageFieldTag.TRADING_SESSION_ID, priceTerminal.getId()));
        group.addChild(factory.createStringField(PdasMessageFieldTag.TRADING_SESSION_SUB_ID, priceTerminal.getSubId()));
        pdasMessageList.addChild(group);
        mainGroup.addChild(pdasMessageList);
        mainGroup.addChild(factory.createStringField(PdasMessageFieldTag.TRADING_SESSION_SUB_ID, priceTerminal.getSubId()));
        mainGroup.addChild(factory.createStringField(PdasMessageFieldTag.FXCM_TIMING_INTERVAL, commandDescriptor.getFxcmTimingInterval()));
        mainGroup.addChild(factory.createStringField(PdasMessageFieldTag.FXCM_DAS_MESSAGE_PRICE_STREAM, commandDescriptor.getFxcmDasMessagePriceStream()));
        mainGroup.addChild(factory.createStringField(PdasMessageFieldTag.TIMEFRAME, commandDescriptor.getFxcmTimingIntervalEx()));
        mainGroup.addChild(factory.createStringField(PdasMessageFieldTag.FXCM_INCLUDE_WEEKENDS, fxcmIncludeWeekends));
        mainGroup.addChild(factory.createStringField(PdasConstants.SID, priceSession.getSessionId()));
        return mainGroup;
    }
}
module.exports = PdasPriceFeedBatchCommandMessage
