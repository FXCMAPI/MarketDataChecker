'use strict';
let csvParser = require('@gehtsoft/LuaxStdlib-node').csvParser;
let stdlib = require('@gehtsoft/LuaxStdlib-node').stdlib;
let ClientMessageBuilder = require('./ClientMessageBuilder.js');
let DateTimeParser = require('./DateTimeParser.js');
let DeflateUtils = require('./DeflateUtils.js');
class ClientMessageCsvParser {
    fieldParser;
    constructor() {
        this.fieldParser = new csvParser();
        this.fieldParser.valueSeparator = ";";
    }
    parse(line) {
        let parts, builder, mailLine;
        if (line == null) {
            return null;
        }
        mailLine = stdlib.trim(line);
        if (mailLine == "0" || stdlib.len(mailLine) == 0) {
            return null;
        }
        parts = this.fieldParser.splitLine(mailLine);
        if (parts.length < 9) {
            return null;
        }
        builder = new ClientMessageBuilder();
        builder.setMessageId(parts[0]);
        builder.setDateTime(DateTimeParser.parseDateTimeFromString(parts[3]));
        builder.setFrom(parts[4]);
        builder.setMessageType(parts[5]);
        builder.setFeature(parts[6]);
        builder.setText(ClientMessageCsvParser.deflate(parts[7]));
        builder.setSubject(ClientMessageCsvParser.deflate(parts[8]));
        return builder.build();
    }
    static deflate(textSource) {
        return DeflateUtils.extractPossibleBase64DeflatedText(textSource);
    }
}
module.exports = ClientMessageCsvParser
